{"version":3,"file":"engine.prepare-options-helpers.js","sourceRoot":"","sources":["../../engine/engine.prepare-options-helpers.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Helper functions for prepareOptions\n *\n * These functions handle the various transformations and validations\n * that prepareOptions performs on deployment options.\n */\n\nimport { logging } from '@angular-devkit/core';\nimport * as util from 'util';\n\nimport { Schema } from '../deploy/schema';\n// Internal API dependency - by design. See getRemoteUrl() JSDoc for rationale and fallback options.\nimport Git from 'gh-pages/lib/git';\n\n/**\n * Type for options with the three boolean flags that prepareOptions adds,\n * plus the optional user object created from name + email\n */\nexport type PreparedOptions = Schema & {\n  dotfiles: boolean;\n  notfound: boolean;\n  nojekyll: boolean;\n  user?: { name: string; email: string };\n};\n\n// Store original debuglog for cleanup (using CommonJS require for mutable access)\n// eslint-disable-next-line @typescript-eslint/no-var-requires\nconst utilMutable = require('util');\nlet originalDebuglog: typeof util.debuglog | null = null;\n\n/**\n * Setup monkeypatch for util.debuglog to intercept gh-pages logging\n *\n * gh-pages uses util.debuglog('gh-pages') internally for all verbose logging.\n * We intercept it and forward to Angular logger instead of stderr.\n *\n * CRITICAL: This must be called BEFORE requiring gh-pages, otherwise gh-pages\n * will cache the original util.debuglog and our interception won't work.\n *\n * NOTE: We use require('util') instead of ES import because ES module namespace\n * objects are read-only. CommonJS require returns a mutable object that we can patch.\n */\nexport function setupMonkeypatch(logger: logging.LoggerApi): void {\n  // Guard against multiple calls - only patch once\n  // If we're already patched, just return (prevents stack overflow from recursive calls)\n  if (originalDebuglog !== null) {\n    return;\n  }\n\n  originalDebuglog = utilMutable.debuglog;\n\n  utilMutable.debuglog = (set: string) => {\n    // gh-pages uses util.debuglog('gh-pages') internally for all verbose logging\n    // Intercept it and forward to Angular logger instead of stderr\n    if (set === 'gh-pages') {\n      return function (...args: unknown[]) {\n        const message = util.format.apply(util, args);\n        logger.info(message);\n      };\n    }\n    return originalDebuglog!(set);\n  };\n}\n\n/**\n * Cleanup monkeypatch - restore original util.debuglog\n * Exported for testing\n */\nexport function cleanupMonkeypatch(): void {\n  if (originalDebuglog) {\n    utilMutable.debuglog = originalDebuglog;\n    originalDebuglog = null;\n  }\n}\n\n/**\n * Map negated boolean options to positive boolean options\n *\n * Angular-CLI is NOT renaming the vars, so noDotfiles, noNotfound, and noNojekyll\n * come in with no change. We map this to dotfiles, notfound, nojekyll to have a\n * consistent pattern between Commander and Angular-CLI.\n */\nexport function mapNegatedBooleans(\n  options: PreparedOptions,\n  origOptions: Schema\n): void {\n  if (origOptions.noDotfiles !== undefined) {\n    options.dotfiles = !origOptions.noDotfiles;\n  }\n  if (origOptions.noNotfound !== undefined) {\n    options.notfound = !origOptions.noNotfound;\n  }\n  if (origOptions.noNojekyll !== undefined) {\n    options.nojekyll = !origOptions.noNojekyll;\n  }\n}\n\n/**\n * Handle user credentials - create user object or warn if only one is set\n */\nexport function handleUserCredentials(\n  options: PreparedOptions,\n  origOptions: Schema,\n  logger: logging.LoggerApi\n): void {\n  if (options.name && options.email) {\n    options.user = {\n      name: options.name,\n      email: options.email\n    };\n  } else if (options.name || options.email) {\n    logger.warn(\n      'WARNING: Both --name and --email must be set together to configure git user. ' +\n      (options.name ? 'Only --name is set.' : 'Only --email is set.') +\n      ' Git will use the local or global git config instead.'\n    );\n  }\n}\n\n/**\n * Warn if deprecated parameters are used\n */\nexport function warnDeprecatedParameters(origOptions: Schema, logger: logging.LoggerApi): void {\n  if (origOptions.noSilent !== undefined) {\n    logger.warn(\n      'The --no-silent parameter is deprecated and no longer needed. ' +\n      'Verbose logging is now always enabled. This parameter will be ignored.'\n    );\n  }\n}\n\n/**\n * Append CI environment metadata to commit message\n */\nexport function appendCIMetadata(options: PreparedOptions): void {\n  if (process.env.TRAVIS) {\n    options.message +=\n      ' -- ' +\n      (process.env.TRAVIS_COMMIT_MESSAGE || '') +\n      ' \\n\\n' +\n      'Triggered by commit: https://github.com/' +\n      (process.env.TRAVIS_REPO_SLUG || '') +\n      '/commit/' +\n      (process.env.TRAVIS_COMMIT || '') +\n      '\\n' +\n      'Travis CI build: ' +\n      (process.env.TRAVIS_BUILD_WEB_URL || '');\n  }\n\n  if (process.env.CIRCLECI) {\n    options.message +=\n      '\\n\\n' +\n      'Triggered by commit: https://github.com/' +\n      (process.env.CIRCLE_PROJECT_USERNAME || '') +\n      '/' +\n      (process.env.CIRCLE_PROJECT_REPONAME || '') +\n      '/commit/' +\n      (process.env.CIRCLE_SHA1 || '') +\n      '\\n' +\n      'CircleCI build: ' +\n      (process.env.CIRCLE_BUILD_URL || '');\n  }\n\n  if (process.env.GITHUB_ACTIONS) {\n    options.message +=\n      '\\n\\n' +\n      'Triggered by commit: https://github.com/' +\n      (process.env.GITHUB_REPOSITORY || '') +\n      '/commit/' +\n      (process.env.GITHUB_SHA || '') +\n      '\\n' +\n      'GitHub Actions build: ' +\n      (process.env.GITHUB_SERVER_URL || 'https://github.com') +\n      '/' +\n      (process.env.GITHUB_REPOSITORY || '') +\n      '/actions/runs/' +\n      (process.env.GITHUB_RUN_ID || '');\n  }\n}\n\n/**\n * Inject authentication token into repository URL\n *\n * Supports GH_TOKEN, PERSONAL_TOKEN, and GITHUB_TOKEN environment variables.\n * Also handles legacy GH_TOKEN placeholder replacement for backwards compatibility.\n */\nexport async function injectTokenIntoRepoUrl(options: PreparedOptions): Promise<void> {\n  // NEW in 0.6.2: always discover remote URL (if not set)\n  // this allows us to inject tokens from environment even if `--repo` is not set manually\n  if (!options.repo) {\n    options.repo = await getRemoteUrl(options);\n  }\n\n  // for backwards compatibility only,\n  // in the past --repo=https://GH_TOKEN@github.com/<username>/<repositoryname>.git was advised\n  //\n  // this replacement was also used to inject other tokens into the URL,\n  // so it should only be removed with the next major version\n  if (\n    process.env.GH_TOKEN &&\n    options.repo &&\n    options.repo.includes('GH_TOKEN')\n  ) {\n    options.repo = options.repo.replace('GH_TOKEN', process.env.GH_TOKEN);\n  }\n  // preferred way: token is replaced from plain URL\n  // Note: Only the first available token is used (GH_TOKEN > PERSONAL_TOKEN > GITHUB_TOKEN)\n  else if (options.repo && !options.repo.includes('x-access-token:')) {\n    if (process.env.GH_TOKEN) {\n      options.repo = options.repo.replace(\n        'https://github.com/',\n        `https://x-access-token:${process.env.GH_TOKEN}@github.com/`\n      );\n    } else if (process.env.PERSONAL_TOKEN) {\n      options.repo = options.repo.replace(\n        'https://github.com/',\n        `https://x-access-token:${process.env.PERSONAL_TOKEN}@github.com/`\n      );\n    } else if (process.env.GITHUB_TOKEN) {\n      options.repo = options.repo.replace(\n        'https://github.com/',\n        `https://x-access-token:${process.env.GITHUB_TOKEN}@github.com/`\n      );\n    }\n  }\n}\n\n/**\n * Get the remote URL from the git repository\n *\n * ⚠️  WARNING: This uses gh-pages internal API (gh-pages/lib/git)\n *\n * UPGRADE RISK:\n * - This function depends on gh-pages/lib/git which is an internal module\n * - Not part of gh-pages public API - could break in any version\n * - When upgrading gh-pages, verify this still works:\n *   1. Check if gh-pages/lib/git still exists\n *   2. Check if Git class constructor signature is unchanged\n *   3. Check if getRemoteUrl() method still exists and works\n *\n * FALLBACK OPTIONS if this breaks:\n * - Option 1: Shell out to `git config --get remote.origin.url` directly\n * - Option 2: Use a dedicated git library (simple-git, nodegit)\n * - Option 3: Require users to always pass --repo explicitly\n *\n * IMPORTANT: This function expects options.remote to be set (our defaults provide 'origin')\n * It should NOT be called with undefined remote, as gh-pages will convert it to string \"undefined\"\n *\n * Exported for testing - internal use only\n */\nexport async function getRemoteUrl(options: Schema & { git?: string; remote?: string }): Promise<string> {\n  // process.cwd() returns the directory from which ng deploy was invoked.\n  // This is the expected behavior - users run ng deploy from their project root.\n  const git = new Git(process.cwd(), options.git);\n  return await git.getRemoteUrl(options.remote);\n}\n"]}