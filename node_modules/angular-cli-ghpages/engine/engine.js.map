{"version":3,"file":"engine.js","sourceRoot":"","sources":["../../engine/engine.ts"],"names":[],"mappings":"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","sourcesContent":["import {logging} from '@angular-devkit/core';\nimport * as fs from 'fs/promises';\nimport * as path from 'path';\n\nimport {Schema} from '../deploy/schema';\nimport {pathExists} from '../utils';\nimport {GHPages, PublishOptions} from '../interfaces';\nimport {defaults} from './defaults';\nimport {\n  PreparedOptions,\n  setupMonkeypatch,\n  mapNegatedBooleans,\n  handleUserCredentials,\n  warnDeprecatedParameters,\n  appendCIMetadata,\n  injectTokenIntoRepoUrl\n} from './engine.prepare-options-helpers';\n\nexport async function run(\n  dir: string,\n  options: PreparedOptions,\n  logger: logging.LoggerApi\n) {\n  options = await prepareOptions(options, logger);\n\n  // CRITICAL: Must require gh-pages AFTER monkeypatching util.debuglog\n  // gh-pages calls util.debuglog('gh-pages') during module initialization to set up its logger.\n  // If we require gh-pages before monkeypatching, it caches the original util.debuglog,\n  // and our monkeypatch won't capture the logging output.\n  // See prepareOptions() for the monkeypatch implementation.\n  // Note: Dynamic import required for monkeypatch timing (static import would cache before patch)\n  const ghpages = require('gh-pages');\n\n  // always clean the cache directory.\n  // avoids \"Error: Remote url mismatch.\"\n  if (options.dryRun) {\n    logger.info('Dry-run / SKIPPED: cleaning of the cache directory');\n  } else {\n    ghpages.clean();\n  }\n\n  await checkIfDistFolderExists(dir);\n  await createNotFoundFile(dir, options, logger);\n  // Note: CNAME and .nojekyll files are now created by gh-pages v6+ via options\n  await publishViaGhPages(ghpages, dir, options, logger);\n\n  if (!options.dryRun) {\n    logger.info(\n      'ðŸŒŸ Successfully published via angular-cli-ghpages! Have a nice day!'\n    );\n  }\n}\n\n/**\n * Prepare and validate deployment options\n *\n * This orchestrator function:\n * 1. Merges defaults with user options\n * 2. Sets up monkeypatch for gh-pages logging\n * 3. Maps negated boolean options (noDotfiles â†’ dotfiles)\n * 4. Handles user credentials\n * 5. Warns about deprecated parameters\n * 6. Appends CI environment metadata\n * 7. Discovers and injects remote URL with authentication tokens\n * 8. Logs dry-run message if applicable\n */\nexport async function prepareOptions(\n  origOptions: Schema,\n  logger: logging.LoggerApi\n): Promise<PreparedOptions> {\n  // 1. Merge defaults with user options\n  const options: PreparedOptions = {\n    ...defaults,\n    ...origOptions\n  };\n\n  // 2. Setup monkeypatch for gh-pages logging (MUST be before requiring gh-pages)\n  setupMonkeypatch(logger);\n\n  // 3. Map negated boolean options\n  mapNegatedBooleans(options, origOptions);\n\n  // 4. Handle user credentials\n  handleUserCredentials(options, origOptions, logger);\n\n  // 5. Warn about deprecated parameters\n  warnDeprecatedParameters(origOptions, logger);\n\n  // 6. Append CI environment metadata\n  appendCIMetadata(options);\n\n  // 7. Discover and inject remote URL with authentication tokens\n  await injectTokenIntoRepoUrl(options);\n\n  // 8. Log dry-run message if applicable\n  if (options.dryRun) {\n    logger.info('Dry-run: No changes are applied at all.');\n  }\n\n  return options;\n}\n\nasync function checkIfDistFolderExists(dir: string) {\n  if (!await pathExists(dir)) {\n    throw new Error(\n      'Dist folder does not exist. Check the dir --dir parameter or build the project first!'\n    );\n  }\n}\n\nasync function createNotFoundFile(\n  dir: string,\n  options: {\n    notfound: boolean,\n    dryRun?: boolean\n  },\n  logger: logging.LoggerApi\n) {\n  if (!options.notfound) {\n    return;\n  }\n\n  if (options.dryRun) {\n    logger.info('Dry-run / SKIPPED: copying of index.html to 404.html');\n    return;\n  }\n\n  // Note:\n  // There is no guarantee that there will be an index.html file,\n  // as we may may specify a custom index file or a different folder is going to be deployed.\n  const indexHtml = path.join(dir, 'index.html');\n  const notFoundFile = path.join(dir, '404.html');\n\n  try {\n    await fs.copyFile(indexHtml, notFoundFile);\n    logger.info('404.html file created');\n  } catch (err) {\n    const message = err instanceof Error ? err.message : String(err);\n    logger.info('index.html could not be copied to 404.html. Proceeding without it.');\n    logger.debug('Diagnostic info: ' + message);\n    return;\n  }\n}\n\n// CNAME and .nojekyll files are now handled by gh-pages v6+ via the cname/nojekyll options\n// Previously we created these files ourselves before publishing, but gh-pages PR #533 added native support\n\nasync function publishViaGhPages(\n  ghPages: GHPages,\n  dir: string,\n  options: PreparedOptions,\n  logger: logging.LoggerApi\n) {\n  if (options.dryRun) {\n    // Note: options.repo may contain auth tokens. This is acceptable because:\n    // 1. CI environments (GitHub Actions, etc.) automatically mask secrets in logs\n    // 2. Dry-run is typically used for debugging, where seeing the full URL helps\n    // 3. Local dry-runs don't persist logs\n    logger.info(\n      `Dry-run / SKIPPED: publishing folder '${dir}' with the following options: ` +\n      JSON.stringify(\n        {\n          dir,\n          repo: options.repo || 'current working directory (which must be a git repo in this case) will be used to commit & push',\n          remote: options.remote,\n          message: options.message,\n          branch: options.branch,\n          name: options.name ? `the name '${options.name}' will be used for the commit` : 'local or global git user name will be used for the commit',\n          email: options.email ? `the email '${options.email}' will be used for the commit` : 'local or global git user email will be used for the commit',\n          dotfiles: options.dotfiles ? `files starting with dot ('.') will be included` : `files starting with dot ('.') will be ignored`,\n          notfound: options.notfound ? 'a 404.html file will be created' : 'a 404.html file will NOT be created',\n          nojekyll: options.nojekyll ? 'a .nojekyll file will be created' : 'a .nojekyll file will NOT be created',\n          cname: options.cname ? `a CNAME file with the content '${options.cname}' will be created` : 'a CNAME file will NOT be created',\n          add: options.add ? 'all files will be added to the branch. Existing files will not be removed' : 'existing files will be removed from the branch before adding the new ones',\n        },\n        null,\n        '  '\n      )\n    );\n    return;\n  }\n\n  logger.info('ðŸš€ Uploading via git, please wait...');\n\n  // Only pass options that gh-pages understands\n  // gh-pages v6+ supports cname and nojekyll options natively (PR #533)\n  const ghPagesOptions: PublishOptions = {\n    repo: options.repo,\n    branch: options.branch,\n    message: options.message,\n    remote: options.remote,\n    git: options.git as string | undefined,\n    add: options.add,\n    dotfiles: options.dotfiles,\n    user: options.user,\n    cname: options.cname,\n    nojekyll: options.nojekyll\n  };\n\n  // gh-pages v5+ fixed the Promise bug where errors didn't reject properly\n  // We can now safely await the promise directly\n  await ghPages.publish(dir, ghPagesOptions);\n}\n"]}